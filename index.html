<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Height Prediction Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background: #f4f8fc; }
    .container { max-width: 960px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
    h1 { text-align: center; color: #222; margin-bottom: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1 1 220px; min-width: 180px; }
    label { display:block; font-weight:600; margin-top:8px; }
    input, select, button { width:100%; padding:8px 10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; }
    button { background:#0078D7; color:#fff; font-weight:600; cursor:pointer; }
    button.secondary { background:#555; }
    .controls { margin-top:12px; display:flex; gap:8px; }
    .result { margin-top:18px; padding:14px; background:#e8f4ff; border-radius:10px; border-left:5px solid #0078D7; white-space:pre-wrap; }
    .small { font-size:0.9rem; color:#444; }
    canvas { margin-top:18px; background:#fff; border-radius:8px; padding:8px; }
    .msg { margin-top:8px; font-weight:600; }
    .success { color:green; }
    .error { color:crimson; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Height Prediction Calculator</h1>

    <!-- Name -->
    <div class="row">
      <div class="col">
        <label for="name">Name</label>
        <input id="name" type="text" placeholder="Child's name (optional)">
      </div>
    </div>

    <!-- Location -->
    <div class="row">
      <div class="col">
        <label for="country">Country</label>
        <input id="country" type="text" placeholder="Country">
      </div>
      <div class="col">
        <label for="state">State</label>
        <input id="state" type="text" placeholder="State">
      </div>
      <div class="col">
        <label for="district">District</label>
        <input id="district" type="text" placeholder="District">
      </div>
    </div>

    <!-- Gender, Age, Height -->
    <div class="row">
      <div class="col">
        <label for="gender">Gender</label>
        <select id="gender">
          <option value="Male">Male</option>
          <option value="Female">Female</option>
        </select>
      </div>
      <div class="col">
        <label for="age">Current Age (years, decimals allowed)</label>
        <input id="age" type="number" step="0.01" min="0" max="20" placeholder="e.g. 7.5">
      </div>
      <div class="col">
        <label for="height">Current Height (cm)</label>
        <input id="height" type="number" step="0.1" min="0" placeholder="e.g. 125.4">
      </div>
    </div>

    <!-- Mode toggle -->
    <div class="row">
      <div class="col">
        <label>Prediction Mode</label>
        <select id="mode" onchange="toggleParents()">
          <option value="child">Child only (Percentile-based)</option>
          <option value="child_parents">Child + Parents (Percentile + MPH)</option>
        </select>
      </div>
    </div>

    <!-- Parents Heights (hidden by default) -->
    <div class="row" id="parentsSection" style="display:none;">
      <div class="col">
        <label for="father">Father's Height (cm)</label>
        <input id="father" type="number" step="0.1" min="0" placeholder="e.g. 172.0">
      </div>
      <div class="col">
        <label for="mother">Mother's Height (cm)</label>
        <input id="mother" type="number" step="0.1" min="0" placeholder="e.g. 160.0">
      </div>
    </div>

    <!-- Adult age -->
    <div class="row">
      <div class="col">
        <label for="adultAge">Project adult height to age</label>
        <select id="adultAge">
          <option value="18">18 years</option>
          <option value="20">20 years</option>
        </select>
      </div>
    </div>

    <!-- Buttons -->
    <div class="row">
      <div class="col">
        <div class="controls">
          <button id="predictBtn" onclick="predictHeight()">Predict</button>
          <button onclick="window.print()" class="secondary">üñ® Print</button>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div id="results" class="result" style="display:none;"></div>
    <div id="logMsg" class="msg" style="display:none;"></div>

    <!-- Chart -->
    <canvas id="growthChart" width="920" height="420"></canvas>
    <div class="small">Red = current, Green = percentile-based predicted, Purple = MPH-based predicted (if parents provided), Blue dashed = trajectory.</div>
  </div>

<script>
const SHEET_WEBAPP_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL";
let chart = null;

function toggleParents() {
  const mode = document.getElementById("mode").value;
  const parentsSection = document.getElementById("parentsSection");
  if (mode === "child_parents") {
    parentsSection.style.display = "flex";
  } else {
    parentsSection.style.display = "none";
    document.getElementById("father").value = "";
    document.getElementById("mother").value = "";
  }
}

async function loadJsonFile(filename) {
  const res = await fetch(filename, { cache: "no-store" });
  if (!res.ok) throw new Error("Could not load " + filename);
  return res.json();
}

async function predictHeight() {
  const name = document.getElementById("name").value.trim();
  const country = document.getElementById("country").value.trim();
  const state = document.getElementById("state").value.trim();
  const district = document.getElementById("district").value.trim();
  const gender = document.getElementById("gender").value;
  const age = parseFloat(document.getElementById("age").value);
  const currentHeight = parseFloat(document.getElementById("height").value);
  const father = parseFloat(document.getElementById("father").value);
  const mother = parseFloat(document.getElementById("mother").value);
  const adultAge = parseInt(document.getElementById("adultAge").value, 10);
  const mode = document.getElementById("mode").value;
  const resultBox = document.getElementById("results");

  if (isNaN(age) || isNaN(currentHeight)) {
    resultBox.style.display = "block";
    resultBox.innerText = "‚ùå Please enter valid age and current height.";
    return;
  }

  try {
    const mainFile = gender === "Male" ? "Male.json" : "Female.json";
    const mainJson = await loadJsonFile(mainFile);
    const mainData = mainJson.data;

    // --- Percentile-based prediction ---
    let lower = mainData[0];
    for (let i=0;i<mainData.length;i++){
      if (mainData[i].Age <= age) lower = mainData[i]; else break;
    }
    let upper = mainData.find(item => item.Age >= age) || mainData[mainData.length-1];
    const factor = (age - lower.Age) / ((upper.Age - lower.Age) || 1);
    const percentileKeys = Object.keys(lower).filter(k => k !== "Age");
    const interpolated = {};
    percentileKeys.forEach(k => {
      interpolated[k] = Number(lower[k]) + factor * (Number(upper[k]) - Number(lower[k]));
    });
    let nearest = percentileKeys[0];
    let minDiff = Math.abs(interpolated[nearest] - currentHeight);
    percentileKeys.forEach(k => {
      const diff = Math.abs(interpolated[k] - currentHeight);
      if (diff < minDiff) { minDiff = diff; nearest = k; }
    });
    const adultRow = mainData.find(r => r.Age === adultAge) || mainData[mainData.length-1];
    const predicted_percentileBased = Number(adultRow[nearest]);

    // --- MPH-based prediction (if mode=child_parents) ---
    let predicted_mph = null, mphPercentile = null, mph = null;
    if (mode === "child_parents" && !isNaN(father) && !isNaN(mother)) {
      mph = (father + mother) / 2;
      const mphFile = gender === "Male" ? "male_mph.json" : "female_mph.json";
      const mphJson = await loadJsonFile(mphFile);
      const mphData = mphJson.data;
      let closestRow = mphData[0];
      let minDiff = Math.abs(mphData[0].Midparental_m - mph);
      mphData.forEach(row => {
        const diff = Math.abs(row.Midparental_m - mph);
        if (diff < minDiff) { minDiff = diff; closestRow = row; }
      });
      mphPercentile = closestRow.Percentile;
      if (adultRow[mphPercentile]) {
        predicted_mph = Number(adultRow[mphPercentile]);
      }
    }

    // --- Display ---
    let html = "";
    html += `‚úÖ Gender: <b>${gender}</b>\n`;
    html += `‚úÖ Age: <b>${age} years</b>\n`;
    html += `üåç Country: <b>${country||"-"}</b>\n`;
    html += `üèûÔ∏è State: <b>${state||"-"}</b>, District: <b>${district||"-"}</b>\n\n`;
    html += `üìä Predicted Adult Height (Percentile-based): <b>${predicted_percentileBased} cm</b>\n`;
    if (predicted_mph) {
      html += `üìä Predicted Adult Height (MPH-based): <b>${predicted_mph} cm</b>\n`;
    }
    resultBox.style.display = "block";
    resultBox.innerHTML = html;

    // --- Chart ---
    drawChart(mainData, age, currentHeight, adultAge, predicted_percentileBased, predicted_mph, nearest, mphPercentile);

    // --- Logging payload ---
    const payload = {
      timestamp: new Date().toISOString(),
      name, country, state, district, gender, age, currentHeight,
      percentile_current: nearest,
      predicted_percentileBased,
      father: isNaN(father) ? "" : father,
      mother: isNaN(mother) ? "" : mother,
      mph: mph || "",
      mph_percentile: mphPercentile || "",
      predicted_mph: predicted_mph || ""
    };
    logToSheet(payload);

  } catch (err) {
    resultBox.style.display = "block";
    resultBox.innerText = "‚ùå Error: " + err.message;
  }
}

function drawChart(mainData, age, currentHeight, adultAge, predicted_percentileBased, predicted_mph, nearestPercentile, mphPercentile) {
  const chartPercentiles = ["P3","P10","P25","P50","P75","P90","P97"];
  const datasets = chartPercentiles.map(p => ({
    label: p,
    data: mainData.map(d => ({ x: d.Age, y: Number(d[p]) })),
    borderColor: getColor(p),
    borderWidth: 2,
    fill: false,
    tension: 0.3,
    pointRadius: 0
  }));

  // trajectory (percentile-based)
  const trajectory = mainData.filter(d => d.Age >= age && d.Age <= adultAge).map(d => ({ x: d.Age, y: Number(d[nearestPercentile]) }));
  datasets.push({
    label: "Trajectory",
    data: trajectory,
    borderColor: "blue",
    borderWidth: 3,
    borderDash: [6,4],
    fill: false,
    tension: 0,
    pointRadius: 0
  });

  // current point
  datasets.push({
    label: "Current",
    data: [{ x: age, y: currentHeight }],
    backgroundColor: "red",
    borderColor: "red",
    pointRadius: 6,
    type: "scatter"
  });

  // predicted percentile-based
  datasets.push({
    label: "Predicted (Percentile)",
    data: [{ x: adultAge, y: predicted_percentileBased }],
    backgroundColor: "green",
    borderColor: "green",
    pointRadius: 6,
    type: "scatter"
  });

  // predicted MPH-based (only if valid)
  if (predicted_mph) {
    datasets.push({
      label: "Predicted (MPH)",
      data: [{ x: adultAge, y: predicted_mph }],
      backgroundColor: "purple",
      borderColor: "purple",
      pointRadius: 6,
      type: "scatter"
    });
    if (mphPercentile && mainData[0].hasOwnProperty(mphPercentile)) {
      const mphTrajectory = mainData.filter(d => d.Age >= age && d.Age <= adultAge).map(d => ({ x: d.Age, y: Number(d[mphPercentile]) }));
      datasets.push({
        label: "MPH Trajectory",
        data: mphTrajectory,
        borderColor: "purple",
        borderWidth: 2,
        borderDash: [3,3],
        fill: false,
        tension: 0,
        pointRadius: 0
      });
    }
  }

  if (chart) chart.destroy();
  const ctx = document.getElementById("growthChart").getContext("2d");
  chart = new Chart(ctx, {
    type: "line",
    data: { datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" },
        tooltip: {
          callbacks: {
            label: c => `${c.dataset.label}: ${c.parsed.y} cm at age ${c.parsed.x}`
          }
        }
      },
      scales: {
        x: { type: "linear", title: { display: true, text: "Age (years)" } },
        y: { title: { display: true, text: "Height (cm)" } }
      }
    }
  });
}

function getColor(p) {
  const map = { "P3":"#ff6384","P10":"#ff9f40","P25":"#ffcd56","P50":"#4bc0c0","P75":"#36a2eb","P90":"#9966ff","P97":"#c9cbcf" };
  return map[p] || "#666";
}

async function logToSheet(payload) {
  try {
    await fetch(https://script.google.com/macros/s/AKfycbwYVMNKkBrmFkTbX4zA4Kk2lVp5yIr8bwJZqr00JaeLtJQB4gE8xiZqMxtT-JH5BgBeJg/exec, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    console.log("‚úÖ Logged to Google Sheets:", payload);
  } catch (e) {
    console.error("‚ö†Ô∏è Failed to log:", e);
  }
}
</script>
</body>
</html>
















