<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Height Prediction Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background: #f4f8fc; }
    .container { max-width: 920px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
    h1 { text-align: center; color: #222; margin-bottom: 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1 1 220px; min-width: 180px; }
    label { display:block; font-weight:600; margin-top:8px; }
    input, select, button { width:100%; padding:8px 10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; }
    button { background:#0078D7; color:#fff; font-weight:600; cursor:pointer; }
    button.secondary { background:#555; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .controls { margin-top:12px; display:flex; gap:8px; }
    .result { margin-top:18px; padding:14px; background:#e8f4ff; border-radius:10px; border-left:5px solid #0078D7; white-space:pre-wrap; }
    .small { font-size:0.9rem; color:#444; }
    canvas { margin-top:18px; background:#fff; border-radius:8px; padding:8px; }
    .msg { margin-top:8px; font-weight:600; }
    .success { color:green; }
    .error { color:crimson; }
    .actions { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Height Prediction Calculator</h1>

    <div class="row">
      <div class="col">
        <label for="name">Name</label>
        <input id="name" type="text" placeholder="Child's name (optional)">
      </div>

      <div class="col">
        <label for="state">State</label>
        <input id="state" type="text" placeholder="State">
      </div>

      <div class="col">
        <label for="district">District</label>
        <input id="district" type="text" placeholder="District">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="gender">Gender</label>
        <select id="gender">
          <option value="Male">Male</option>
          <option value="Female">Female</option>
        </select>
      </div>

      <div class="col">
        <label for="age">Current Age (years, decimals allowed)</label>
        <input id="age" type="number" step="0.01" min="0" max="20" placeholder="e.g. 7.5">
      </div>

      <div class="col">
        <label for="height">Current Height (cm)</label>
        <input id="height" type="number" step="0.1" min="0" placeholder="e.g. 125.4">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="adultAge">Project adult height to age</label>
        <select id="adultAge">
          <option value="18">18 years</option>
          <option value="20">20 years</option>
        </select>
      </div>

      <div class="col">
        <label>&nbsp;</label>
        <div class="controls">
          <button id="predictBtn" onclick="predictHeight()">Predict</button>
          <button id="printBtn" onclick="window.print()" class="secondary">🖨 Print</button>
          <button id="exportBtn" onclick="exportLocalLog()" class="secondary">⬇ Export logs (local)</button>
        </div>
      </div>
    </div>

    <div id="results" class="result" style="display:none;"></div>
    <div id="logMsg" class="msg" style="display:none;"></div>

    <canvas id="growthChart" width="880" height="420"></canvas>
    <div class="small">Tip: Chart is interactive — hover points to see exact values.</div>
  </div>

<script>
/* -------------------------
  Config: Google Apps Script URL
   (already provided by you)
---------------------------*/
const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz73tJdxWhXBMxIjsWcN6WNWLnFkK8OPYpjNIrb0oV5JNj4efTyfDRuh4LMWv7A1BtwaQ/exec";

/* local storage key for cached logs */
const LOCAL_LOG_KEY = "height_predictor_local_logs_v1";

/* global chart instance */
let chart = null;

/* helper: load JSON file (Male.json or Female.json) */
async function loadJsonFile(gender) {
  const filename = gender === "Male" ? "Male.json" : "Female.json";
  const res = await fetch(filename, {cache: "no-store"});
  if (!res.ok) throw new Error("Could not load " + filename);
  return res.json();
}

/* main prediction function */
async function predictHeight() {
  // UI disables
  const predictBtn = document.getElementById("predictBtn");
  predictBtn.disabled = true;
  document.getElementById("logMsg").style.display = "none";

  const name = document.getElementById("name").value.trim();
  const state = document.getElementById("state").value.trim();
  const district = document.getElementById("district").value.trim();
  const gender = document.getElementById("gender").value;
  const age = parseFloat(document.getElementById("age").value);
  const currentHeight = parseFloat(document.getElementById("height").value);
  const adultAge = parseInt(document.getElementById("adultAge").value, 10);
  const resultBox = document.getElementById("results");

  // validation
  if (isNaN(age) || isNaN(currentHeight) || age < 0) {
    predictBtn.disabled = false;
    resultBox.style.display = "block";
    resultBox.innerText = "❌ Please enter a valid age and height.";
    return;
  }

  try {
    // load json dataset
    const json = await loadJsonFile(gender);
    const data = json.data;

    // clamp age within dataset range
    const minAge = data[0].Age;
    const maxAge = data[data.length - 1].Age;
    const clampedAge = Math.max(minAge, Math.min(maxAge, age));

    // find lower and upper rows for interpolation
    let lower = data[0];
    for (let i=0;i<data.length;i++){
      if (data[i].Age <= clampedAge) lower = data[i];
      else break;
    }
    let upper = data.find(item => item.Age >= clampedAge) || data[data.length-1];

    // if clampedAge exactly matches upper or lower, factor becomes 0
    const denom = (upper.Age - lower.Age) || 1;
    const factor = (clampedAge - lower.Age) / denom;

    // interpolate each percentile between lower and upper
    const percentileKeys = Object.keys(lower).filter(k => k !== "Age");
    const interpolated = {};
    percentileKeys.forEach(k => {
      const lv = Number(lower[k]);
      const uv = Number(upper[k]);
      interpolated[k] = lv + factor * (uv - lv);
    });

    // find nearest percentile
    let nearest = percentileKeys[0];
    let minDiff = Math.abs(interpolated[nearest] - currentHeight);
    percentileKeys.forEach(k => {
      const diff = Math.abs(interpolated[k] - currentHeight);
      if (diff < minDiff) { minDiff = diff; nearest = k; }
    });

    // project to chosen adultAge: find row that matches adultAge in dataset (or nearest)
    const adultRow = data.find(r => r.Age === adultAge) || data[data.length-1];
    const predicted = Number(adultRow[nearest]);
    const sd = predicted * 0.045;
    const lowerRange = Number(predicted - sd).toFixed(2);
    const upperRange = Number(predicted + sd).toFixed(2);

    // show results
    resultBox.style.display = "block";
    resultBox.innerHTML = 
      `👤 Name: ${name || "-"}\n` +
      `🌍 Location: ${state || "-"}${state && district ? ", " : ""}${district || ""}\n` +
      `✅ Gender: ${gender}\n` +
      `✅ Current Age: ${age} years\n` +
      `✅ Current Height: ${currentHeight} cm\n` +
      `📊 Nearest Percentile: ${nearest}\n\n` +
      `🔮 Predicted Height at age ${adultAge} (following ${nearest}): ${predicted} cm\n` +
      `Range (±4.5%): ${lowerRange} – ${upperRange} cm\n`;

    // prepare chart data and draw
    drawChart(data, percentileKeys, age, currentHeight, adultAge, predicted);

    // prepare payload with timestamp
    const payload = {
      timestamp: (new Date()).toISOString(),
      name: name || "",
      state: state || "",
      district: district || "",
      gender,
      age,
      currentHeight,
      percentile: nearest,
      adultAge,
      predicted,
      lowerRange,
      upperRange
    };

    // save to local storage (always)
    saveLocalLog(payload);

    // send to Google Sheet (async) and show success/failure
    try {
      const logResult = await logToSheet(payload);
      showLogMessage("📤 Data saved to Google Sheets ✅", true);
      console.log("Google Sheets logged:", logResult);
    } catch (err) {
      showLogMessage("⚠️ Logging to Google Sheets failed. Saved locally instead.", false);
      console.error("Logging failed:", err);
    }

  } catch (err) {
    console.error(err);
    resultBox.style.display = "block";
    resultBox.innerText = "❌ Error: " + (err.message || "Failed to calculate");
  } finally {
    predictBtn.disabled = false;
  }
}

/* draw chart with percentile curves and points */
function drawChart(data, percentileKeys, age, currentHeight, adultAge, predicted) {
  // convert curves to (x,y) points
  const curveDatasets = percentileKeys.filter(k => ["P3","P10","P25","P50","P75","P90","P97"].includes(k)).map(k => {
    return {
      label: k,
      data: data.map(d => ({ x: d.Age, y: Number(d[k]) })),
      borderColor: getColor(k),
      borderWidth: 2,
      fill: false,
      tension: 0.3,
      pointRadius: 0
    };
  });

  // child's current point (at exact decimal age)
  const currentPointDS = {
    label: "Current",
    data: [{ x: age, y: currentHeight }],
    backgroundColor: "red",
    borderColor: "red",
    pointRadius: 6,
    showLine: false,
    type: 'scatter'
  };

  // predicted adult point
  const predictedPointDS = {
    label: "Predicted (adult)",
    data: [{ x: adultAge, y: predicted }],
    backgroundColor: "green",
    borderColor: "green",
    pointRadius: 6,
    showLine: false,
    type: 'scatter'
  };

  const datasets = [...curveDatasets, currentPointDS, predictedPointDS];

  // destroy existing chart if present
  if (chart) chart.destroy();

  const ctx = document.getElementById("growthChart").getContext("2d");

  chart = new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      maintainAspectRatio: false,
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          mode: 'nearest',
          intersect: true,
          callbacks: {
            label: function(context) {
              const ds = context.dataset;
              const x = context.parsed.x;
              const y = context.parsed.y;
              if (ds.label === 'Current') return `Current: age ${x}, ${y} cm`;
              if (ds.label === 'Predicted (adult)') return `Predicted: age ${x}, ${y} cm`;
              return `${ds.label}: ${y} cm (age ${x})`;
            }
          }
        }
      },
      scales: {
        x: {
          type: 'linear',
          position: 'bottom',
          title: { display: true, text: 'Age (years)' },
          min: data[0].Age,
          max: data[data.length-1].Age
        },
        y: {
          title: { display: true, text: 'Height (cm)' }
        }
      }
    }
  });
}

/* color map */
function getColor(k) {
  const map = {
    "P3": "rgba(255,99,132,1)",
    "P10": "rgba(255,159,64,1)",
    "P25": "rgba(255,205,86,1)",
    "P50": "rgba(75,192,192,1)",
    "P75": "rgba(54,162,235,1)",
    "P90": "rgba(153,102,255,1)",
    "P97": "rgba(201,203,207,1)"
  };
  return map[k] || "#666";
}

/* --- Local storage helpers --- */
function getLocalLogs() {
  try {
    const raw = localStorage.getItem(LOCAL_LOG_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch (e) {
    return [];
  }
}
function saveLocalLog(record) {
  const logs = getLocalLogs();
  logs.push(record);
  // keep last 1000 records only
  if (logs.length > 1000) logs.splice(0, logs.length - 1000);
  localStorage.setItem(LOCAL_LOG_KEY, JSON.stringify(logs));
}

/* export local logs as CSV */
function exportLocalLog() {
  const logs = getLocalLogs();
  if (!logs.length) {
    alert("No local logs to export.");
    return;
  }
  const headers = Object.keys(logs[0]);
  const csvRows = [];
  csvRows.push(headers.join(","));
  logs.forEach(r => {
    csvRows.push(headers.map(h => {
      const v = r[h];
      if (v === null || v === undefined) return "";
      // escape quotes
      return `"${String(v).replace(/"/g, '""')}"`;
    }).join(","));
  });
  const csv = csvRows.join("\n");
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `height_predictor_logs_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* --- Google Sheets logging function ---
   Posts JSON payload to your Apps Script Web App.
   It returns a resolved Promise when response.ok.
*/
async function logToSheet(payload) {
  const res = await fetch(SHEET_WEBAPP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) {
    const text = await res.text().catch(()=>null);
    throw new Error("Sheet logging failed: " + (text || res.status));
  }
  // return text if needed
  return res.text().catch(()=>"ok");
}

/* small UI helper to show log message */
function showLogMessage(msg, success=true) {
  const el = document.getElementById("logMsg");
  el.style.display = "block";
  el.innerText = msg;
  el.className = success ? "msg success" : "msg error";
  // hide after 6 seconds
  setTimeout(()=>{ el.style.display = "none"; }, 6000);
}

/* init: draw empty chart skeleton */
window.addEventListener("load", async ()=> {
  // draw empty skeleton with Male by default
  try {
    const json = await loadJsonFile("Male");
    const data = json.data;
    const percentileKeys = Object.keys(data[0]).filter(k => k !== "Age");
    drawChart(data, percentileKeys, 0, 0, 18, 0);
  } catch (e) {
    console.warn("Could not draw initial chart:", e);
  }
});
</script>
</body>
</html>










