<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Height Prediction Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background: #f4f8fc; }
    .container { max-width: 960px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
    h1 { text-align: center; color: #222; margin-bottom: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-start; }
    .col { flex: 1 1 220px; min-width: 180px; }
    label { display:block; font-weight:600; margin-top:8px; }
    input, select, button { width:100%; padding:8px 10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; }
    button { background:#0078D7; color:#fff; font-weight:600; cursor:pointer; }
    button.secondary { background:#555; }
    .controls { margin-top:12px; display:flex; gap:8px; }
    .result { margin-top:18px; padding:14px; background:#e8f4ff; border-radius:10px; border-left:5px solid #0078D7; white-space:pre-wrap; }
    .small { font-size:0.9rem; color:#444; }
    canvas { margin-top:18px; background:#fff; border-radius:8px; padding:8px; }
    .msg { margin-top:8px; font-weight:600; }
    .success { color:green; }
    .error { color:crimson; }
  </style>

  <!-- toggleParents early so inline onchange won't fail -->
  <script>
    // Define globally so inline onchange finds it early
    window.toggleParents = function() {
      try {
        var modeEl = document.getElementById("mode");
        var parentsSection = document.getElementById("parentsSection");
        if (!modeEl || !parentsSection) return;
        var mode = modeEl.value;
        if (mode === "child_parents") {
          parentsSection.style.display = "flex";
        } else {
          parentsSection.style.display = "none";
          var f = document.getElementById("father");
          var m = document.getElementById("mother");
          if (f) f.value = "";
          if (m) m.value = "";
        }
      } catch (e) {
        console.warn("toggleParents error:", e);
      }
    };
  </script>
</head>
<body>
  <div class="container">
    <h1>Height Prediction Calculator</h1>

    <div class="row">
      <div class="col">
        <label for="mode">Prediction Mode</label>
        <select id="mode" aria-label="Prediction mode" onchange="toggleParents()">
          <option value="child">Child only (Percentile-based)</option>
          <option value="child_parents">Child + Parents (Percentile + MPH)</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:6px;">
      <div class="col">
        <label for="name">Name</label>
        <input id="name" type="text" placeholder="Child's name (optional)">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="country">Country</label>
        <input id="country" type="text" placeholder="Country">
      </div>
      <div class="col">
        <label for="state">State</label>
        <input id="state" type="text" placeholder="State">
      </div>
      <div class="col">
        <label for="district">District</label>
        <input id="district" type="text" placeholder="District">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="gender">Gender</label>
        <select id="gender">
          <option value="Male">Male</option>
          <option value="Female">Female</option>
        </select>
      </div>
      <div class="col">
        <label for="age">Current Age (years, decimals allowed)</label>
        <input id="age" type="number" step="0.01" min="0" max="20" placeholder="e.g. 7.5">
      </div>
      <div class="col">
        <label for="height">Current Height (cm)</label>
        <input id="height" type="number" step="0.1" min="0" placeholder="e.g. 125.4">
      </div>
    </div>

    <div class="row" id="parentsSection" style="display:none; margin-top:8px; align-items:flex-end;">
      <div class="col">
        <label for="father">Father's Height (cm)</label>
        <input id="father" type="number" step="0.1" min="0" placeholder="e.g. 172.0">
      </div>
      <div class="col">
        <label for="mother">Mother's Height (cm)</label>
        <input id="mother" type="number" step="0.1" min="0" placeholder="e.g. 160.0">
      </div>
      <div class="col" style="min-width:160px;">
        <label for="adultAge">Project adult height to age</label>
        <select id="adultAge">
          <option value="18">18 years</option>
          <option value="20">20 years</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="controls">
          <button id="predictBtn">Predict</button>
          <button id="printBtn" class="secondary">🖨 Print</button>
        </div>
      </div>
    </div>

    <div id="results" class="result" style="display:none;"></div>
    <div id="logMsg" class="msg" style="display:none;"></div>

    <canvas id="growthChart" width="920" height="420"></canvas>
    <div class="small">Red = current, Green = percentile-based predicted, Purple = MPH-based predicted (if parents provided), Blue dashed = trajectory.</div>
  </div>

<script>
/* Configuration: set your Apps Script URL here (or empty to skip) */
const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz73tJdxWhXBMxIjsWcN6WNWLnFkK8OPYpjNIrb0oV5JNj4efTyfDRuh4LMWv7A1BtwaQ/exec";

/* DOM refs */
const modeEl = document.getElementById("mode");
const predictBtn = document.getElementById("predictBtn");
const printBtn = document.getElementById("printBtn");
const resultsEl = document.getElementById("results");
const logMsgEl = document.getElementById("logMsg");
let chart = null;

/* Events */
document.addEventListener("DOMContentLoaded", () => {
  if (modeEl) modeEl.addEventListener("change", toggleParents);
  if (predictBtn) predictBtn.addEventListener("click", onPredictClicked);
  if (printBtn) printBtn.addEventListener("click", () => window.print());
  toggleParents();
  initSkeletonChart();
});

/* Robust JSON loader */
async function loadJsonFile(filename) {
  const tryUrls = [];
  tryUrls.push(filename);
  try { const base = location.href.substring(0, location.href.lastIndexOf('/') + 1); tryUrls.push(base + filename); } catch(e){}
  try { const url = new URL(filename, location.href); tryUrls.push(url.href); } catch(e){}

  for (const u of tryUrls) {
    console.log("Attempting to fetch:", u);
    try {
      const res = await fetch(u, { cache: "no-store" });
      if (!res.ok) { console.warn("Fetch returned", res.status, "for", u); continue; }
      return await res.json();
    } catch (err) {
      console.warn("Fetch error for", u, err);
      continue;
    }
  }

  // Embedded fallback for MPH files (testing only)
  if (filename.toLowerCase().includes("female_mph")) {
    console.warn("Using embedded fallback female_mph data (testing only).");
    return { data: [
      {"Mother_cm":140,"Father_cm":153,"Midparental_m":146.5,"Percentile":"P25"},
      {"Mother_cm":150,"Father_cm":165,"Midparental_m":157.5,"Percentile":"P50"},
      {"Mother_cm":155,"Father_cm":175,"Midparental_m":165,"Percentile":"P75"}
    ]};
  }
  if (filename.toLowerCase().includes("male_mph")) {
    console.warn("Using embedded fallback male_mph data (testing only).");
    return { data: [
      {"Mother_cm":150,"Father_cm":160,"Midparental_m":155,"Percentile":"P25"},
      {"Mother_cm":160,"Father_cm":170,"Midparental_m":165,"Percentile":"P50"},
      {"Mother_cm":165,"Father_cm":175,"Midparental_m":170,"Percentile":"P75"}
    ]};
  }

  throw new Error("Unable to load JSON file: " + filename + ". Check file exists in same folder and server is running.");
}

/* Predict handler */
async function onPredictClicked() {
  if (predictBtn) predictBtn.disabled = true;
  logMsgEl.style.display = "none";
  try {
    await predictHeight();
  } catch (err) {
    resultsEl.style.display = "block";
    resultsEl.innerText = "❌ Error: " + (err.message || String(err));
    console.error(err);
  } finally {
    if (predictBtn) predictBtn.disabled = false;
  }
}

/* Main prediction */
async function predictHeight() {
  const mode = document.getElementById("mode").value;
  const name = document.getElementById("name").value.trim();
  const country = document.getElementById("country").value.trim();
  const state = document.getElementById("state").value.trim();
  const district = document.getElementById("district").value.trim();
  const gender = document.getElementById("gender").value;
  const age = parseFloat(document.getElementById("age").value);
  const currentHeight = parseFloat(document.getElementById("height").value);
  const father = parseFloat(document.getElementById("father").value);
  const mother = parseFloat(document.getElementById("mother").value);
  const adultAge = parseInt(document.getElementById("adultAge").value, 10);

  if (isNaN(age) || isNaN(currentHeight)) {
    resultsEl.style.display = "block";
    resultsEl.innerText = "❌ Please enter valid age and current height.";
    return;
  }

  const mainFile = gender === "Male" ? "Male.json" : "Female.json";
  const mainJson = await loadJsonFile(mainFile);
  const mainData = Array.isArray(mainJson.data) ? mainJson.data : mainJson;
  mainData.sort((a,b)=>Number(a.Age)-Number(b.Age));

  const minAge = Number(mainData[0].Age);
  const maxAge = Number(mainData[mainData.length-1].Age);
  const clampedAge = Math.max(minAge, Math.min(maxAge, age));

  let lower = mainData[0];
  for (let i=0;i<mainData.length;i++){
    if (Number(mainData[i].Age) <= clampedAge) lower = mainData[i]; else break;
  }
  let upper = mainData.find(item => Number(item.Age) >= clampedAge) || mainData[mainData.length - 1];
  const denom = (Number(upper.Age) - Number(lower.Age)) || 1;
  const factor = (clampedAge - Number(lower.Age)) / denom;

  const percentileKeys = Object.keys(lower).filter(k => k !== "Age");
  const interpolated = {};
  percentileKeys.forEach(k => {
    const lowV = Number(lower[k]);
    const upV = Number(upper[k]);
    interpolated[k] = Number.isFinite(lowV) && Number.isFinite(upV) ? (lowV + factor * (upV - lowV)) : NaN;
  });

  let nearest = percentileKeys.length ? percentileKeys[0] : null;
  if (nearest) {
    let minDiff = Math.abs((interpolated[nearest]||0) - currentHeight);
    percentileKeys.forEach(k => {
      const val = interpolated[k];
      if (!Number.isFinite(val)) return;
      const diff = Math.abs(val - currentHeight);
      if (diff < minDiff) { minDiff = diff; nearest = k; }
    });
  }

  const adultRow = mainData.find(r => Number(r.Age) === Number(adultAge)) || mainData[mainData.length - 1];

  let predicted_percentileBased = null;
  if (nearest && adultRow && Object.prototype.hasOwnProperty.call(adultRow, nearest)) {
    predicted_percentileBased = Number(adultRow[nearest]);
  } else if (adultRow && Object.prototype.hasOwnProperty.call(adultRow,'P50')) {
    predicted_percentileBased = Number(adultRow['P50']);
  } else {
    predicted_percentileBased = NaN;
  }

  let mph = null, mphPercentile = null, predicted_mph = null;
  if (mode === "child_parents" && !isNaN(father) && !isNaN(mother)) {
    mph = (father + mother) / 2;
    const mphFile = gender === "Male" ? "male_mph.json" : "female_mph.json";
    try {
      const mphJson = await loadJsonFile(mphFile);
      let mphData = Array.isArray(mphJson.data) ? mphJson.data : (Array.isArray(mphJson) ? mphJson : (mphJson.data ? mphJson.data : []));

      const mpFieldCandidates = ['Midparental_m','Midparental','midparental_m','midparental','midparental_cm','Midparental_cm'];

      if (mphData.length) {
        let closest = mphData[0];
        let mpVal0 = getFirstFieldValue(mphData[0], mpFieldCandidates);
        let mdiff = Math.abs(mpVal0 - mph);
        for (let i=0;i<mphData.length;i++){
          const row = mphData[i];
          const mpVal = getFirstFieldValue(row, mpFieldCandidates);
          if (!Number.isFinite(mpVal)) continue;
          const diff = Math.abs(mpVal - mph);
          if (diff < mdiff) { mdiff = diff; closest = row; }
        }
        mphPercentile = (closest.Percentile || closest.percentile || closest.p || closest.P) || null;
        if (mphPercentile && !Object.prototype.hasOwnProperty.call(adultRow, mphPercentile)) {
          const asNum = Number(mphPercentile);
          if (Number.isFinite(asNum)) mphPercentile = 'P' + asNum;
        }
        if (mphPercentile && adultRow && Object.prototype.hasOwnProperty.call(adultRow, mphPercentile)) {
          predicted_mph = Number(adultRow[mphPercentile]);
        }
      }
    } catch(e) {
      console.warn('MPH file missing or invalid, skipping MPH method', e);
    }
  }

  let html = "";
  html += "✅ Gender: <b>" + gender + "</b>\n";
  html += "✅ Age: <b>" + age + " years</b>\n";
  html += "🌍 Country: <b>" + (country || "-") + "</b>\n";
  html += "🏞️ State: <b>" + (state || "-") + "</b>, District: <b>" + (district || "-") + "</b>\n\n";
  html += "📊 Predicted Adult Height (Percentile-based): <b>" + (Number.isFinite(predicted_percentileBased) ? (predicted_percentileBased + " cm") : "N/A") + "</b>\n";
  if (predicted_mph !== null && Number.isFinite(predicted_mph)) {
    html += "📊 Predicted Adult Height (MPH-based): <b>" + predicted_mph + " cm</b>\n";
  }
  resultsEl.style.display = "block";
  resultsEl.innerHTML = html;

  drawChart(mainData, age, currentHeight, adultAge, predicted_percentileBased, predicted_mph, nearest, mphPercentile);

  const payload = {
    timestamp: new Date().toISOString(),
    name: name || "",
    country: country || "",
    state: state || "",
    district: district || "",
    gender: gender,
    age: age,
    currentHeight: currentHeight,
    percentile_current: nearest || '',
    predicted_percentileBased: Number.isFinite(predicted_percentileBased) ? predicted_percentileBased : '',
    father: !isNaN(father) ? father : "",
    mother: !isNaN(mother) ? mother : "",
    mph: mph !== null ? Number(mph.toFixed(2)) : "",
    mph_percentile: mphPercentile || "",
    predicted_mph: (predicted_mph !== null && Number.isFinite(predicted_mph)) ? predicted_mph : ""
  };

  try {
    await logToSheet(payload);
    showLogMessage("📤 Data saved to Google Sheets ✅", true);
  } catch (err) {
    console.error("Logging failed:", err);
    showLogMessage("⚠️ Logging to Google Sheets failed.", false);
  }
}

/* Chart drawing */
function drawChart(mainData, age, currentHeight, adultAge, predicted_percentileBased, predicted_mph, nearestPercentile, mphPercentile) {
  const chartPercentiles = ["P3","P10","P25","P50","P75","P90","P97"];
  const datasets = chartPercentiles.map(function(p) {
    return {
      label: p,
      data: mainData.map(function(d) { return { x: Number(d.Age), y: Number(d[p]) }; }),
      borderColor: getColor(p),
      borderWidth: 2,
      fill: false,
      tension: 0.3,
      pointRadius: 0
    };
  });

  const trajectory = mainData.filter(function(d){ return Number(d.Age) >= age && Number(d.Age) <= adultAge; })
    .map(function(d){ return { x: Number(d.Age), y: Number(d[nearestPercentile] || d['P50']) }; });

  datasets.push({
    label: "Trajectory",
    data: trajectory,
    borderColor: "blue",
    borderWidth: 3,
    borderDash: [6,4],
    fill: false,
    tension: 0,
    pointRadius: 0
  });

  datasets.push({
    label: "Current",
    data: [{ x: age, y: currentHeight }],
    backgroundColor: "red",
    borderColor: "red",
    pointRadius: 6,
    type: "scatter"
  });

  datasets.push({
    label: "Predicted (Percentile)",
    data: [{ x: adultAge, y: predicted_percentileBased }],
    backgroundColor: "green",
    borderColor: "green",
    pointRadius: 6,
    type: "scatter"
  });

  if (predicted_mph !== null && predicted_mph !== undefined && predicted_mph !== "") {
    datasets.push({
      label: "Predicted (MPH)",
      data: [{ x: adultAge, y: predicted_mph }],
      backgroundColor: "purple",
      borderColor: "purple",
      pointRadius: 6,
      type: "scatter"
    });

    if (mphPercentile && mainData[0] && Object.prototype.hasOwnProperty.call(mainData[0], mphPercentile)) {
      const mphTrajectory = mainData.filter(function(d){ return Number(d.Age) >= age && Number(d.Age) <= adultAge; })
        .map(function(d){ return { x: Number(d.Age), y: Number(d[mphPercentile]) }; });
      datasets.push({
        label: "MPH Trajectory",
        data: mphTrajectory,
        borderColor: "purple",
        borderWidth: 2,
        borderDash: [3,3],
        fill: false,
        tension: 0,
        pointRadius: 0
      });
    }
  }

  if (chart) chart.destroy();
  const ctx = document.getElementById("growthChart").getContext("2d");
  chart = new Chart(ctx, {
    type: "line",
    data: { datasets: datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" },
        tooltip: {
          callbacks: {
            label: function(c) { return c.dataset.label + ": " + c.parsed.y + " cm at age " + c.parsed.x; }
          }
        }
      },
      scales: {
        x: { type: "linear", title: { display: true, text: "Age (years)" } },
        y: { title: { display: true, text: "Height (cm)" } }
      }
    }
  });
}

function getColor(p) {
  const map = { "P3":"#ff6384","P10":"#ff9f40","P25":"#ffcd56","P50":"#4bc0c0","P75":"#36a2eb","P90":"#9966ff","P97":"#c9cbcf" };
  return map[p] || "#666";
}

function getFirstFieldValue(obj, candidates) {
  for (var i = 0; i < candidates.length; i++) {
    var k = candidates[i];
    if (obj && Object.prototype.hasOwnProperty.call(obj, k)) {
      var v = Number(obj[k]);
      if (Number.isFinite(v)) return v;
    }
  }
  var keys = Object.keys(obj||{});
  for (var j = 0; j < keys.length; j++) {
    var kk = keys[j];
    var vv = Number(obj[kk]);
    if (Number.isFinite(vv)) return vv;
  }
  return NaN;
}

/* Logging to Google Sheets Apps Script */
async function logToSheet(payload) {
  if (!SHEET_WEBAPP_URL || SHEET_WEBAPP_URL.trim() === "") return Promise.resolve('skipped');
  const res = await fetch(https://script.google.com/macros/s/AKfycbzA6TuYpP2IkBFpx6udY5mo1hgxIqK0T3f0FwtGaV5BStqkToffKKmgkbueT-l9_Jx5WQ/exec, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) {
    const txt = await res.text().catch(()=>res.statusText);
    throw new Error("Sheet logging failed: " + txt);
  }
  return res.text().catch(()=>"ok");
}

function showLogMessage(msg, ok) {
  ok = (typeof ok === "undefined") ? true : ok;
  logMsgEl.style.display = "block";
  logMsgEl.innerText = msg;
  logMsgEl.className = ok ? "msg success" : "msg error";
  setTimeout(function(){ logMsgEl.style.display = "none"; }, 6000);
}

async function initSkeletonChart() {
  try {
    const json = await loadJsonFile("Male.json");
    const data = Array.isArray(json.data) ? json.data : json;
    drawChart(data, 0, 0, 18, 0, null, "P50", null);
  } catch (e) { console.warn('Could not draw skeleton chart (Male.json missing)', e); }
}
</script>
</body>
</html>






