<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Height Prediction Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f4f8fc; }
    .container { max-width: 900px; margin: auto; background: white; padding: 20px;
                 border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    h1 { text-align: center; color: #222; margin-bottom: 8px; }
    label { display:block; margin-top:10px; font-weight:600; }
    input, select, button { width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid #cfcfcf; }
    .result { margin-top:20px; padding:15px; background:#e8f4ff; border-radius:10px; border-left:5px solid #0078D7; white-space:pre-wrap; }
    button { background:#0078D7; color:white; font-size:16px; cursor:pointer; }
    button:hover { background:#005a9e; }
    canvas { margin-top:18px; max-width:100%; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Height Prediction Calculator</h1>

    <label><input type="radio" name="method" value="1" checked> Method 1 ‚Äì Only child's height</label>
    <label><input type="radio" name="method" value="2"> Method 2 ‚Äì Child + Parents' heights</label>

    <label for="name">Name:</label><input id="name" type="text">
    <label for="state">State:</label><input id="state" type="text">
    <label for="district">District:</label><input id="district" type="text">
    <label for="gender">Gender:</label><select id="gender"><option>Male</option><option>Female</option></select>
    <label for="age">Age (years):</label><input id="age" type="number" step="0.1">
    <label for="height">Height (cm):</label><input id="height" type="number" step="0.1">

    <div id="parentFields" style="display:none;">
      <label for="motherHeight">Mother's Height (cm):</label><input id="motherHeight" type="number" step="0.1">
      <label for="fatherHeight">Father's Height (cm):</label><input id="fatherHeight" type="number" step="0.1">
    </div>

    <button id="predictBtn">Predict</button>
    <button id="printBtn" style="display:none" onclick="window.print()">üñ® Print</button>
    <div id="results" class="result" style="display:none"></div>
    <canvas id="growthChart"></canvas>
  </div>

<script>
let chart = null;
const percentLabelMap = [{key:"P3",v:3},{key:"P10",v:10},{key:"P25",v:25},{key:"P50",v:50},{key:"P75",v:75},{key:"P90",v:90},{key:"P97",v:97}];

document.querySelectorAll('input[name="method"]').forEach(el=>{
  el.addEventListener("change",()=>{
    document.getElementById("parentFields").style.display = 
      (document.querySelector('input[name="method"]:checked').value==="2") ? "block":"none";
    document.getElementById("results").style.display="none";
    document.getElementById("printBtn").style.display="none";
  });
});

function toNum(v){const n=Number(v);return Number.isFinite(n)?n:NaN;}
function rr(n){return (Math.round(n*100)/100).toFixed(2);}
function getColor(p){return{"P3":"red","P10":"orange","P25":"gold","P50":"green","P75":"blue","P90":"purple","P97":"gray"}[p]||"black";}
function mapNumericPercentileToLabel(num){if(Number.isNaN(num))return"P50";let best=percentLabelMap[0];for(const p of percentLabelMap)if(Math.abs(p.v-num)<Math.abs(best.v-num))best=p;return best.key;}

document.getElementById("predictBtn").addEventListener("click",predictHeight);

async function predictHeight(){
  const rb=document.getElementById("results");
  rb.style.display="none";
  document.getElementById("printBtn").style.display="none";
  try{
    const method=document.querySelector('input[name="method"]:checked').value;
    const name=document.getElementById("name").value.trim();
    const state=document.getElementById("state").value.trim();
    const district=document.getElementById("district").value.trim();
    const gender=document.getElementById("gender").value;
    const age=toNum(document.getElementById("age").value);
    const currentHeight=toNum(document.getElementById("height").value);

    if(!name||!state||!district||Number.isNaN(age)||Number.isNaN(currentHeight)){
      rb.style.display="block"; rb.innerText="‚ùå Please fill all fields correctly."; return;
    }

    // Load growth data
    const growthFile=(gender==="Male")?"Male.json":"Female.json";
    const res=await fetch(growthFile); if(!res.ok)throw new Error("Growth file missing");
    const growthJson=await res.json();
    const growthData=Array.isArray(growthJson)?growthJson:(growthJson.data||growthJson);

    const ps=Object.keys(growthData[0]).filter(k=>/^P\d+/.test(k));
    const sorted=growthData.slice().sort((a,b)=>toNum(a.Age)-toNum(b.Age));

    // find nearest age rows
    let lower=sorted[0], upper=sorted[sorted.length-1];
    for(let r of sorted){if(toNum(r.Age)<=age)lower=r;if(toNum(r.Age)>=age){upper=r;break;}}
    const f=(age-toNum(lower.Age))/((toNum(upper.Age)-toNum(lower.Age))||1);

    // interpolate
    const interp={}; ps.forEach(pk=>interp[pk]=toNum(lower[pk])+f*(toNum(upper[pk])-toNum(lower[pk])));
    let nearest=ps[0], diff=Math.abs(interp[nearest]-currentHeight);
    ps.forEach(pk=>{let d=Math.abs(interp[pk]-currentHeight); if(d<diff){diff=d;nearest=pk;}});

    const adultRow=sorted.find(r=>Math.round(toNum(r.Age))===18)||sorted[sorted.length-1];
    const predicted1=toNum(adultRow[nearest]);
    const sd1=predicted1*0.0175, lower1=rr(predicted1-sd1), upper1=rr(predicted1+sd1);

    let out=`üë§ ${name}\nüìç ${state}, ${district}\n‚öß ${gender}\nüéÇ Age: ${age}\nüìè Height: ${currentHeight} cm\n`;
    let predicted2=null, avg=null;
    const plotPts=[{x:age,y:currentHeight,color:"red",label:"Current"},{x:18,y:predicted1,color:"green",label:"Predicted1"}];

    if(method==="1"){
      out+=`\nüîÆ Predicted Height 1: ${predicted1} cm\nRange: ${lower1} ‚Äì ${upper1} cm`;
    } else {
      const mom=toNum(document.getElementById("motherHeight").value);
      const dad=toNum(document.getElementById("fatherHeight").value);
      if(Number.isNaN(mom)||Number.isNaN(dad)){rb.style.display="block";rb.innerText="‚ùå Provide both parents' heights.";return;}

      const mphFile=(gender==="Male")?"male_mph.json":"female_mph.json";
      const mphRes=await fetch(mphFile); const mphData=await mphRes.json();
      const mphVal=Math.round((mom+dad)/2);
      let nearestRow=mphData.reduce((b,c)=>Math.abs(toNum(c.Midparental_m)-mphVal)<Math.abs(toNum(b.Midparental_m)-mphVal)?c:b,mphData[0]);
      const mapped=mapNumericPercentileToLabel(toNum(nearestRow.Percentile));

      predicted2=toNum(adultRow[mapped])||toNum(adultRow["P50"]);
      avg=(predicted1+predicted2)/2;
      const sd2=avg*0.0175, l2=rr(avg-sd2), u2=rr(avg+sd2);
      out+=`\nüîÆ Predicted Height 1: ${predicted1} cm (Range: ${lower1}‚Äì${upper1})\nüîÆ Predicted Height 2 (Avg): ${rr(avg)} cm (Range: ${l2}‚Äì${u2})`;
      plotPts.push({x:18,y:rr(avg),color:"blue",label:"Predicted2"});
    }

    // Save to Google Sheets
    const sheetData={name,state,district,gender,age,currentHeight,
      motherHeight:(method==="2")?document.getElementById("motherHeight").value:null,
      fatherHeight:(method==="2")?document.getElementById("fatherHeight").value:null,
      predicted1,predicted2,avgPredicted:avg};

    fetch("https://script.google.com/macros/s/AKfycbzG8OpRMpsDrtAJOE7zHrE7EDN9AYsESPCeGTAwUDOSc65t3FL5Rpsyd3ivN4hdnFjSpg/exec", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(sheetData)
})
    .then(r=>r.text()).then(txt=>console.log("Sheets:",txt))
    .catch(err=>console.error("Sheets error:",err));

    // show results
    rb.style.display="block"; rb.innerText=out; document.getElementById("printBtn").style.display="inline-block";

    // chart
    const datasets=ps.map(pk=>({label:pk,data:growthData.map(r=>({x:toNum(r.Age),y:toNum(r[pk])})),
      borderColor:getColor(pk),backgroundColor:getColor(pk),fill:false,tension:0.2,pointRadius:0}));
    plotPts.forEach(pt=>datasets.push({label:pt.label,data:[{x:toNum(pt.x),y:toNum(pt.y)}],
      borderColor:pt.color,backgroundColor:pt.color,pointRadius:12,pointStyle:"circle",showLine:false}));
    if(chart)chart.destroy(); chart=new Chart(document.getElementById("growthChart"),{type:"line",data:{datasets},
      options:{responsive:true,plugins:{legend:{position:"bottom"}},scales:{x:{type:"linear",title:{display:true,text:"Age"}},y:{title:{display:true,text:"Height (cm)"}}}}});
  }catch(err){console.error(err);rb.style.display="block";rb.innerText="‚ùå "+err.message;}
}
</script>
</body>
</html>


