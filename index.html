<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Height Prediction Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background: #f4f8fc; }
    .container { max-width: 920px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
    h1 { text-align: center; color: #222; margin-bottom: 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1 1 220px; min-width: 180px; }
    label { display:block; font-weight:600; margin-top:8px; }
    input, select, button { width:100%; padding:8px 10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; }
    button { background:#0078D7; color:#fff; font-weight:600; cursor:pointer; }
    button.secondary { background:#555; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .controls { margin-top:12px; display:flex; gap:8px; }
    .result { margin-top:18px; padding:14px; background:#e8f4ff; border-radius:10px; border-left:5px solid #0078D7; white-space:pre-wrap; }
    .small { font-size:0.9rem; color:#444; }
    canvas { margin-top:18px; background:#fff; border-radius:8px; padding:8px; }
    .msg { margin-top:8px; font-weight:600; }
    .success { color:green; }
    .error { color:crimson; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Height Prediction Calculator</h1>

    <div class="row">
      <div class="col">
        <label for="name">Name</label>
        <input id="name" type="text" placeholder="Child's name (optional)">
      </div>
      <div class="col">
        <label for="state">State</label>
        <input id="state" type="text" placeholder="State">
      </div>
      <div class="col">
        <label for="district">District</label>
        <input id="district" type="text" placeholder="District">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="gender">Gender</label>
        <select id="gender">
          <option value="Male">Male</option>
          <option value="Female">Female</option>
        </select>
      </div>
      <div class="col">
        <label for="age">Current Age (years, decimals allowed)</label>
        <input id="age" type="number" step="0.01" min="0" max="20" placeholder="e.g. 7.5">
      </div>
      <div class="col">
        <label for="height">Current Height (cm)</label>
        <input id="height" type="number" step="0.1" min="0" placeholder="e.g. 125.4">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="adultAge">Project adult height to age</label>
        <select id="adultAge">
          <option value="18">18 years</option>
          <option value="20">20 years</option>
        </select>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <div class="controls">
          <button id="predictBtn" onclick="predictHeight()">Predict</button>
          <button onclick="window.print()" class="secondary">üñ® Print</button>
        </div>
      </div>
    </div>

    <div id="results" class="result" style="display:none;"></div>
    <div id="logMsg" class="msg" style="display:none;"></div>

    <canvas id="growthChart" width="880" height="420"></canvas>
    <div class="small">Hover over lines to see percentile values. Red = current, Green = predicted, Blue = trajectory.</div>
  </div>

<script>
const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxe7TiE4ga-E8dP9Ms1AsUkVaq1qvJgMMrIGvMySOOXK5KKBTIjvqHrrIlNEgur-ZJPEg/exec";
let chart = null;

/* Load dataset */
async function loadJsonFile(gender) {
  const filename = gender === "Male" ? "Male.json" : "Female.json";
  const res = await fetch(filename, { cache: "no-store" });
  if (!res.ok) throw new Error("Could not load " + filename);
  return res.json();
}

/* Main prediction */
async function predictHeight() {
  const name = document.getElementById("name").value.trim();
  const state = document.getElementById("state").value.trim();
  const district = document.getElementById("district").value.trim();
  const gender = document.getElementById("gender").value;
  const age = parseFloat(document.getElementById("age").value);
  const currentHeight = parseFloat(document.getElementById("height").value);
  const adultAge = parseInt(document.getElementById("adultAge").value, 10);
  const resultBox = document.getElementById("results");

  if (isNaN(age) || isNaN(currentHeight)) {
    resultBox.style.display = "block";
    resultBox.innerText = "‚ùå Please enter a valid age and height.";
    return;
  }

  try {
    const json = await loadJsonFile(gender);
    const data = json.data;

    // Find lower and upper rows for interpolation
    let lower = data[0];
    for (let i=0; i<data.length; i++) {
      if (data[i].Age <= age) lower = data[i]; else break;
    }
    let upper = data.find(item => item.Age >= age) || data[data.length-1];
    const factor = (age - lower.Age) / ((upper.Age - lower.Age) || 1);

    // Interpolated percentiles
    const percentiles = Object.keys(lower).filter(k => k !== "Age");
    const interpolated = {};
    percentiles.forEach(p => {
      interpolated[p] = lower[p] + factor * (upper[p] - lower[p]);
    });

    // Find nearest percentile
    let nearest = percentiles[0];
    let minDiff = Math.abs(interpolated[nearest] - currentHeight);
    percentiles.forEach(p => {
      const diff = Math.abs(interpolated[p] - currentHeight);
      if (diff < minDiff) { minDiff = diff; nearest = p; }
    });

    // Project to adult age
    const adultRow = data.find(r => r.Age === adultAge) || data[data.length-1];
    const predicted = adultRow[nearest];
    const sd = predicted * 0.045;
    const lowerRange = (predicted - sd).toFixed(2);
    const upperRange = (predicted + sd).toFixed(2);

    // Show results
    resultBox.style.display = "block";
    resultBox.innerHTML = `
      üë§ Name: <b>${name||"-"}</b><br>
      üåç Location: <b>${state||"-"}, ${district||"-"}</b><br>
      ‚úÖ Gender: <b>${gender}</b><br>
      ‚úÖ Current Age: <b>${age} years</b><br>
      ‚úÖ Current Height: <b>${currentHeight} cm</b><br>
      üìä Nearest Percentile: <b>${nearest}</b><br><br>
      üîÆ Predicted Adult Height at <b>${adultAge}</b> (following ${nearest}): 
      <b>${predicted} cm</b><br>
      Range (¬±4.5%): <b>${lowerRange} ‚Äì ${upperRange} cm</b>
    `;

    // Draw chart
    drawChart(data, age, currentHeight, adultAge, predicted, nearest);

    // Log data to Google Sheets
    const payload = {
      timestamp: new Date().toLocaleString(),
      name, state, district, gender, age, currentHeight,
      percentile: nearest,
      adultAge, predicted, lowerRange, upperRange
    };
    logToSheet(payload);

  } catch (err) {
    resultBox.style.display = "block";
    resultBox.innerText = "‚ùå Error: " + err.message;
  }
}

/* Chart drawing */
function drawChart(data, age, currentHeight, adultAge, predicted, nearest) {
  const chartPercentiles = ["P3","P10","P25","P50","P75","P90","P97"];

  // Percentile curves
  const datasets = chartPercentiles.map(p => ({
    label: p,
    data: data.map(d => ({ x: d.Age, y: d[p] })),
    borderColor: getColor(p),
    borderWidth: 2,
    fill: false,
    tension: 0.3,
    pointRadius: 0
  }));

  // Child's trajectory (from current age to adultAge, following nearest percentile)
  const trajectory = data
    .filter(d => d.Age >= age && d.Age <= adultAge)
    .map(d => ({ x: d.Age, y: d[nearest] }));

  datasets.push({
    label: "Trajectory",
    data: trajectory,
    borderColor: "blue",
    borderWidth: 3,
    borderDash: [5,5],
    fill: false,
    tension: 0,
    pointRadius: 0
  });

  // Current point
  datasets.push({
    label: "Current",
    data: [{ x: age, y: currentHeight }],
    backgroundColor: "red",
    borderColor: "red",
    pointRadius: 6,
    type: "scatter"
  });

  // Predicted point
  datasets.push({
    label: "Predicted",
    data: [{ x: adultAge, y: predicted }],
    backgroundColor: "green",
    borderColor: "green",
    pointRadius: 6,
    type: "scatter"
  });

  if (chart) chart.destroy();
  const ctx = document.getElementById("growthChart").getContext("2d");
  chart = new Chart(ctx, {
    type: "line",
    data: { datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" },
        tooltip: {
          callbacks: {
            label: c => `${c.dataset.label}: ${c.parsed.y} cm at age ${c.parsed.x}`
          }
        }
      },
      scales: {
        x: { type: "linear", title: { display: true, text: "Age (years)" } },
        y: { title: { display: true, text: "Height (cm)" } }
      }
    }
  });
}

/* Colors */
function getColor(p) {
  const colors = {
    "P3":"#ff6384","P10":"#ff9f40","P25":"#ffcd56",
    "P50":"#4bc0c0","P75":"#36a2eb","P90":"#9966ff","P97":"#c9cbcf"
  };
  return colors[p] || "#666";
}

/* Google Sheets logging */
async function logToSheet(payload) {
  try {
    await fetch(SHEET_WEBAPP_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    console.log("‚úÖ Logged to Google Sheets:", payload);
  } catch (e) {
    console.error("‚ö†Ô∏è Failed to log:", e);
  }
}
</script>
</body>
</html>














